import*as c from"../web_modules/react.js";import*as f from"../web_modules/react-dom.js";import b from"../web_modules/htm.js";import*as l from"../web_modules/fast-json-patch.js";import g from"./event-to-object.js";const u=b.bind(c.createElement),w={};export function mountLayoutWithWebSocket(e,t){if(t.startsWith(".")||t.startsWith("/")){let o=window.location,a;o.protocol==="https:"?a="wss:":a="ws:";let i=a+"//"+o.host;t.startsWith(".")&&(new_url+=o.pathname+"/"),t=i+t}const r=new WebSocket(t);function s(o){r.onmessage=a=>{const[i,$]=JSON.parse(a.data);o(i,$)}}function n(o){r.send(JSON.stringify({header:{},body:{event:o}}))}return mountLayout(e,s,n)}export function mountLayout(e,t,r){f.render(u`<${p} saveUpdateHook=${t} sendEvent=${r} />`,e)}export default function p({saveUpdateHook:e,sendEvent:t}){const[r,s]=P({});return c.useEffect(()=>{e((n,o)=>{s(l.applyPatch(r.current,o.map(a=>(a.path=n+a.path,a)),void 0,!1).newDocument)})},[r]),r.current.tagName?u`<${m}
      sendEvent=${t}
      model=${r.current}
    />`:u`<div />`}function m({sendEvent:e,model:t}){if(t.importSource)return u`<${y} sendEvent=${e} model=${t} />`;{const r=h(e,t),s=d(e,t);return t.children&&t.children.length?u`<${t.tagName} ...${s}>${r}<//>`:u`<${t.tagName} ...${s} />`}}function y({sendEvent:e,model:t}){const r=v(t.importSource.source);if(r){const s=S(r,t.tagName),n=h(e,t),o=d(e,t);return u`<${s} ...${o}>${n}<//>`}else return u`<div>${t.importSource.fallback}<//>`}function h(e,t){return t.children?t.children.map(r=>{switch(typeof r){case"object":return u` <${m} model=${r} sendEvent=${e} /> `;case"string":return r}}):[]}function d(e,t){const r=Object.assign({},t.attributes);return t.eventHandlers&&Object.keys(t.eventHandlers).forEach(s=>{const n=t.eventHandlers[s];r[s]=j(e,n)}),r}function j(e,t){return function(){const r=Array.from(arguments).map(n=>typeof n=="object"&&n.nativeEvent?(t.preventDefault&&n.preventDefault(),t.stopPropagation&&n.stopPropagation(),g(n)):n),s=new Promise((n,o)=>{const a={data:r,target:t.target};e(a),n(a)})}}function v(e){const[t,r]=c.useState(w[e]);return t||E(e).then(r),t}function E(source){return eval(`import('${source}')`).then(e=>e.default?e.default:e,e=>{if(e.stack)return console.log(e),{default:function(){return u`
              <pre>
                  <h1>Error</h1>
                  <code>${[e.stack,e.message]}</code>
                </pre
              >
            `}};throw e})}function S(e,t){const r=t.split("."),s=r.shift();let n=e[s];for(let o=0;o<r.length;o++)n=n[r[o]];return n}function P(e){const t=c.useRef(e),[r,s]=c.useState(e);return t.current=r,[t,s]}
