function U(n,o){var i=Object.keys(n);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(n);o&&(r=r.filter(function(h){return Object.getOwnPropertyDescriptor(n,h).enumerable})),i.push.apply(i,r)}return i}function X(n){for(var o=1;o<arguments.length;o++){var i=arguments[o]!=null?arguments[o]:{};o%2?U(Object(i),!0).forEach(function(r){et(n,r,i[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(i)):U(Object(i)).forEach(function(r){Object.defineProperty(n,r,Object.getOwnPropertyDescriptor(i,r))})}return n}function et(n,o,i){return o in n?Object.defineProperty(n,o,{value:i,enumerable:!0,configurable:!0,writable:!0}):n[o]=i,n}import rt from"../LineChart.js";import{Modes as l,options as ot,transform as nt}from"../../resource/histogram/index.js";import f,{useCallback as q,useEffect as it,useMemo as c,useRef as st,useState as Z}from"../../../web_modules/react.js";import at from"../StackChart.js";import{rem as S,size as F}from"../../utils/style.js";import lt from"../ChartToolbox.js";import{distance as mt}from"../../utils/index.js";import ct from"../../utils/event.js";import{fetcher as ut}from"../../utils/fetch.js";import{format as L}from"../../../web_modules/d3-format.js";import ft from"../../../web_modules/lodash/minBy.js";import dt from"../../../web_modules/query-string.js";import d from"../../../web_modules/styled-components.js";import pt from"../../hooks/useHeavyWork.js";import{useRunningRequest as vt}from"../../hooks/useRequest.js";import ht from"../../hooks/useThrottleFn.js";import{useTranslation as gt}from"../../../web_modules/react-i18next.js";import yt from"../../utils/wasm.js";const M=L(".4f"),Y=L(".4"),_t=()=>yt("histogram_transform").then(n=>o=>n(o.data,o.mode)),xt=d.div.withConfig({displayName:"HistogramChart__Wrapper",componentId:"sc-1nqqqkz-0"})([""," display:flex;flex-direction:column;align-items:stretch;justify-content:space-between;"],F("100%","100%")),bt=d(rt).withConfig({displayName:"HistogramChart__StyledLineChart",componentId:"sc-1nqqqkz-1"})(["flex-grow:1;"]),Ot=d(at).withConfig({displayName:"HistogramChart__StyledStackChart",componentId:"sc-1nqqqkz-2"})(["flex-grow:1;"]),wt=d(lt).withConfig({displayName:"HistogramChart__Toolbox",componentId:"sc-1nqqqkz-3"})(["margin-left:",";margin-right:",";margin-bottom:",";"],S(20),S(20),S(18)),jt=d.div.withConfig({displayName:"HistogramChart__Error",componentId:"sc-1nqqqkz-4"})([""," display:flex;justify-content:center;align-items:center;"],F("100%","100%")),Ct=({cid:n,run:o,tag:i,mode:r,running:h})=>{const{t:u}=gt(["histogram","common"]),g=st(null),{data:p,error:$,loading:y}=vt(`/histogram/list?${dt.stringify({run:o.label,tag:i})}`,!!h,ut,{refreshInterval:60*1e3}),[z,A]=Z(!1),V=q(()=>{ct.emit("toggle-chart-size",n,!z),A(e=>!e)},[n,z]),_=c(()=>`${i} (${o.label})`,[i,o.label]),B=c(()=>({data:p!=null?p:[],mode:r}),[p,r]),s=pt(_t,null,nt,B),[m,x]=Z(null);it(()=>x(null),[r]);const b=c(()=>{if(r===l.Overlay)return s==null?void 0:s.data.map((t,a)=>({name:`${u("common:time-mode.step")}${t[0][1]}`,data:t,lineStyle:{color:o.colors[a===m||m==null?0:1]},z:a===m?s==null?void 0:s.data.length:a,encode:{x:[2],y:[3]}}));if(r===l.Offset){var e;const t=s;return{minX:t==null?void 0:t.minX,maxX:t==null?void 0:t.maxX,minY:t==null?void 0:t.minStep,maxY:t==null?void 0:t.maxStep,minZ:t==null?void 0:t.minZ,maxZ:t==null?void 0:t.maxZ,data:(e=t==null?void 0:t.data)!==null&&e!==void 0?e:[]}}return null},[s,r,o,m,u]),E=c(()=>({[l.Overlay]:e=>{var t;if(!s||m==null)return"";const a=e.find(v=>v.data[1]===s.data[m][0][1]);return(t=a==null?void 0:a.seriesName)!==null&&t!==void 0?t:""},[l.Offset]:e=>e[2]}),[m,s]),I=c(()=>({[l.Overlay]:e=>e.axisDimension==="x"?M(e.value):e.axisDimension==="y"?Y(e.value):"",[l.Offset]:(e,t)=>e.axisDimension==="x"?M(t==null?void 0:t[0]):e.axisDimension==="y"?Y(t==null?void 0:t[1]):""}),[]),O=c(()=>X(X({},ot[r]),{},{color:[o.colors[0]],tooltip:{formatter:E[r]},axisPointer:{label:{formatter:I[r]}},xAxis:{axisPointer:{snap:r===l.Overlay}},yAxis:{axisPointer:{snap:r===l.Overlay}}}),[r,o,E,I]),K=q((e,{offsetX:t,offsetY:a})=>{const v=e.getOption().series,J=[t,a];if(v){var j;const Q=v.map((P,N)=>{var k;return(k=P.data)===null||k===void 0?void 0:k.reduce((R,[,,D,H])=>{const tt=e.convertToPixel("grid",[D,H]),W=mt(tt,J);return W<R[2]?[D,H,W,N]:R},[0,0,Number.POSITIVE_INFINITY,N])}),C=ft(Q,P=>P[2]);x((j=C==null?void 0:C[3])!==null&&j!==void 0?j:null);return}},[]),w=ht(K,{wait:200}),T=q(e=>{const t=e.getZr();t&&(t.on("mousemove",a=>w.run(e,a)),t.on("mouseout",()=>{w.cancel(),x(null)}))},[w]),G=c(()=>r===l.Overlay?f.createElement(bt,{ref:g,title:_,data:b,options:O,loading:y,onInit:T}):r===l.Offset?f.createElement(Ot,{ref:g,title:_,data:b,options:O,loading:y}):null,[b,y,r,O,_,T]);return!s&&$?f.createElement(jt,null,u("common:error")):f.createElement(xt,null,G,f.createElement(wt,{items:[{icon:"maximize",activeIcon:"minimize",tooltip:u("histogram:maximize"),activeTooltip:u("histogram:minimize"),toggle:!0,onClick:V},{icon:"download",tooltip:u("histogram:download-image"),onClick:()=>{var e;return(e=g.current)===null||e===void 0?void 0:e.saveAsImage()}}]}))};export default Ct;
