import t,{useCallback as n,useEffect as z,useImperativeHandle as L,useMemo as ee,useRef as M,useState as a}from"../../web_modules/react.js";import{primaryColor as re,rem as r,size as R,transitionProps as c}from"../utils/style.js";import{AudioPlayer as oe}from"../utils/audio.js";import N from"./Icon.js";import te from"../../web_modules/react-spinners/PuffLoader.js";import ne from"./RangeSlider.js";import le from"../../web_modules/react-rangeslider.js";import ae from"../../web_modules/react-spinners/SyncLoader.js";import ie from"../../web_modules/@tippyjs/react.js";import{fetcher as se}from"../utils/fetch.js";import V from"../../web_modules/mime-types.js";import ce from"../../web_modules/moment.js";import{saveAs as ue}from"../../web_modules/file-saver.js";import $ from"../../web_modules/styled-components.js";import de from"../hooks/useRequest.js";import{useTranslation as me}from"../../web_modules/react-i18next.js";const pe=$.div.withConfig({displayName:"Audio__Container",componentId:"sc-6r7be3-0"})(["background-color:var(--audio-background-color);border-radius:",";display:flex;align-items:center;justify-content:space-between;padding:0 ",";"," > .control{font-size:",";"," line-height:1;margin:0 ",";color:var(--primary-color);cursor:pointer;"," &.volumn{font-size:",";","}&.disabled{color:var(--text-light-color);cursor:not-allowed;}&:hover{color:var(--primary-focused-color);}&:active{color:var(--primary-active-color);}}> .slider{flex-grow:1;padding:0 ",";}> .time{color:var(--text-lighter-color);font-size:",";margin:0 ",";","}"],r(8),r(20),c("background-color"),r(16),R(r(16),r(16)),r(10),c("color"),r(20),R(r(20),r(20)),r(10),r(12),r(5),c("color")),_e=$(le).withConfig({displayName:"Audio__VolumnSlider",componentId:"sc-6r7be3-1"})(["margin:"," ",";width:",";height:",";cursor:pointer;position:relative;background-color:#dbdeeb;outline:none;border-radius:",";user-select:none;"," --color:var(--primary-color);&:hover{--color:var(--primary-focused-color);}&:active{--color:var(--primary-active-color);}.rangeslider__fill{background-color:var(--color);position:absolute;bottom:0;width:100%;border-bottom-left-radius:",";border-bottom-right-radius:",";border-top:"," solid var(--color);box-sizing:content-box;","}.rangeslider__handle{background-color:var(--color);"," position:absolute;left:-",";border-radius:50%;outline:none;"," .rangeslider__handle-tooltip,.rangeslider__handle-label{display:none;}}.rangeslider__labels{display:none;}"],r(15),r(18),r(4),r(100),r(2),c("color"),r(2),r(2),r(4),c(["background-color","color"]),R(r(8),r(8)),r(2),c("background-color")),P=100;function D(d){const i=ce.duration(d,"seconds");return String(Math.floor(i.asMinutes())).padStart(2,"0")+":"+String(i.seconds()).padStart(2,"0")}const fe=t.forwardRef(({audioContext:d,src:i,cache:g,onLoading:m,onLoad:p,className:T},q)=>{const{t:O}=me("common"),{data:l,error:B,loading:H}=de(i!=null?i:null,se,{dedupingInterval:g!=null?g:2e3});L(q,()=>({save:e=>{if(l){const v=l.type?V.extension(l.type):null;ue(l.data,e.replace(/[/\\?%*:|"<>]/g,"_")+(v?`.${v}`:""))}}}));const _=M(null),o=M(null),[X,b]=a(0),[f,y]=a(0),[F,k]=a("00:00"),[E,S]=a(!1),[w,h]=a(!1),[s,j]=a(100),[x,G]=a(!1),U=n(()=>{var e;return(e=o.current)===null||e===void 0?void 0:e.play()},[]),C=n(()=>{var e;return(e=o.current)===null||e===void 0?void 0:e.pause()},[]),J=n(()=>{var e;return(e=o.current)===null||e===void 0?void 0:e.toggle()},[]),K=n(e=>{if(!o.current)return;y(e/P*o.current.duration),b(e)},[]),Q=n(()=>{G(w),C()},[w,C]),W=n(()=>{if(!o.current)return;o.current.seek(f),x&&f<o.current.duration&&U()},[U,f,x]),Y=n(()=>{o.current&&(o.current.toggleMute(),j(o.current.volumn))},[]),u=n(()=>{if(o.current){const e=o.current.current;y(e),b(Math.floor(e/o.current.duration*P))}},[]),I=n(()=>{u(),_.current=window.setInterval(u,250)},[u]),A=n(()=>{o.current&&(o.current.current>=o.current.duration&&u()),_.current&&(window.clearInterval(_.current),_.current=null)},[u]);z(()=>{o.current&&(o.current.volumn=s)},[s]),z(()=>{let e=null;return l&&(async()=>{S(!0),m==null||m(),y(0),b(0),k("00:00"),e=new oe({context:d,onplay:()=>{h(!0),I()},onstop:()=>{h(!1),A()}});const v=await l.data.arrayBuffer();await e.load(v,l.type!=null&&V.extension(l.type)||void 0),S(!1),k(D(e.duration)),p==null||p({sampleRate:e.sampleRate,duration:e.duration}),o.current=e})(),()=>{e&&(h(!1),e.dispose(),o.current=null)}},[l,I,A,m,p,d]);const Z=ee(()=>s===0?"mute":s<=50?"volumn-low":"volumn",[s]);return H?t.createElement(ae,{color:re,size:"15px"}):B?t.createElement("div",null,O("common:error")):t.createElement(pe,{className:T},t.createElement("a",{className:`control ${E?"disabled":""}`,onClick:J},E?t.createElement(te,{size:"16px"}):t.createElement(N,{type:w?"pause":"play"})),t.createElement("div",{className:"slider"},t.createElement(ne,{min:0,max:P,step:1,value:X,disabled:E,onChange:K,onChangeStart:Q,onChangeComplete:W})),t.createElement("span",{className:"time"},D(f),"/",F),t.createElement(ie,{placement:"top",animation:"shift-away-subtle",interactive:!0,hideOnClick:!1,content:t.createElement(_e,{value:s,min:0,max:100,step:1,onChange:j,orientation:"vertical"})},t.createElement("a",{className:"control volumn",onClick:Y},t.createElement(N,{type:Z}))))});export default fe;
