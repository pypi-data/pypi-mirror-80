import o,{useCallback as k,useEffect as y,useMemo as x,useRef as p,useState as C}from"../../../web_modules/react.js";import{ellipsis as I,em as _,primaryColor as V,rem as a,size as A,transitionProps as z}from"../../utils/style.js";import B from"../ChartToolbox.js";import D from"../../../web_modules/react-spinners/GridLoader.js";import H from"./StepSlider.js";import{formatTime as J}from"../../utils/index.js";import N from"../../../web_modules/lodash/isEmpty.js";import q from"../../../web_modules/query-string.js";import f from"../../../web_modules/styled-components.js";import{useRunningRequest as K}from"../../hooks/useRequest.js";import{useTranslation as Q}from"../../../web_modules/react-i18next.js";const X=f.div.withConfig({displayName:"SampleChart__Wrapper",componentId:"sc-19m7v01-0"})(["height:100%;padding:",";padding-bottom:0;display:flex;flex-direction:column;justify-content:flex-start;align-items:stretch;> *{flex-grow:0;flex-shrink:0;}"],_(20)),Y=f.div.withConfig({displayName:"SampleChart__Title",componentId:"sc-19m7v01-1"})(["display:flex;justify-content:space-between;align-items:center;margin-bottom:",";> h4{font-size:",";font-weight:700;flex-shrink:1;flex-grow:1;padding:0;margin:0;","}> span{font-size:",";flex-shrink:0;flex-grow:0;color:var(--text-light-color);"," max-width:50%;"," &::before{content:'';display:inline-block;"," margin-right:",";border-radius:",";vertical-align:middle;background-color:",";}}"],_(20),_(16),I(),_(14),I(),z("color"),A(a(5),a(17)),a(8),a(2.5),n=>n.color),Z=f.div.withConfig({displayName:"SampleChart__Container",componentId:"sc-19m7v01-2"})(["flex-grow:1;flex-shrink:1;margin:"," 0;display:flex;justify-content:center;align-items:center;overflow:hidden;"],_(20)),ee=f.div.withConfig({displayName:"SampleChart__Footer",componentId:"sc-19m7v01-3"})(["margin-bottom:",";display:flex;align-items:center;justify-content:space-between;"],a(18)),te=f.div.withConfig({displayName:"SampleChart__FooterInfo",componentId:"sc-19m7v01-4"})(["color:var(--text-lighter-color);font-size:",";"," > *{display:inline-block;margin-left:",";}"],a(12),z("color"),a(10)),re=(n,l,v,c,g)=>`/${n}/${n}?${q.stringify({index:l,ts:g,run:v,tag:c})}`,ne=({run:n,tag:l,running:v,type:c,cache:g,footer:F,content:R})=>{const{t:m,i18n:G}=Q(["sample","common"]),j=p(null),{data:t,error:S,loading:P}=K(`/${c}/list?${q.stringify({run:n.label,tag:l})}`,!!v),w=x(()=>{var e;return(e=t==null?void 0:t.map(s=>s.step))!==null&&e!==void 0?e:[]},[t]),[r,L]=C(0),[E,U]=C(),i=p({}),d=p(null);y(()=>{Object.values(i.current).forEach(({timer:e})=>clearTimeout(e)),i.current={}},[l,n]);const u=x(()=>{var e;return(e=t==null?void 0:t[r].wallTime)!==null&&e!==void 0?e:0},[t,r]),h=k(()=>{if(!t)return;const e=re(c,r,n.label,l,u);i.current[r]={src:e,timer:setTimeout(()=>{(s=>delete i.current[s])(r)},g)},U(e),d.current=null},[c,r,n.label,l,u,t,g]),O=k(()=>{var e;(e=j.current)===null||e===void 0||e.save(`${n.label}-${l}-${w[r]}-${u.toString().replace(/\./,"_")}`)},[n.label,l,w,r,u]);y(()=>{if(i.current[r])U(i.current[r].src);else if(N(i.current))h();else return d.current=setTimeout(h,500),()=>{d.current!=null&&(clearTimeout(d.current),d.current=null)}},[r,h]);const[$,W]=C(!1),b=p(null),T=p(new IntersectionObserver(e=>{if(e[0].intersectionRatio>0){var s;W(!0),(s=T.current)===null||s===void 0||s.disconnect()}}));y(()=>{const e=T.current;if(b.current&&e)return e.observe(b.current),()=>e.disconnect()},[]);const M=x(()=>P||!i.current[r]||!$?o.createElement(D,{color:V,size:"10px"}):!t&&S?o.createElement("span",null,m("common:error")):N(t)?o.createElement("span",null,m("common:empty")):E?R(j,E):null,[$,P,S,t,r,E,m,R]);return o.createElement(X,null,o.createElement(Y,{color:n.colors[0]},o.createElement("h4",null,l),o.createElement("span",null,n.label)),o.createElement(H,{value:r,steps:w,onChange:L,onChangeComplete:h},J(u,G.language)),o.createElement(Z,{ref:b},M),o.createElement(ee,null,o.createElement(B,{items:[{icon:"download",tooltip:m(`sample:download-${c}`),onClick:O}]}),o.createElement(te,null,o.createElement("span",null,m("sample:sample"),m("common:colon"),(t==null?void 0:t.length)?`${r+1}/${t.length}`:"--/--"),F)))};export default ne;
