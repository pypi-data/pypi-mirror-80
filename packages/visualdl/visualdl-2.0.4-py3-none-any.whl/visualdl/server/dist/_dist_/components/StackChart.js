function de(t,l){var r=Object.keys(t);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(t);l&&(s=s.filter(function(d){return Object.getOwnPropertyDescriptor(t,d).enumerable})),r.push.apply(r,s)}return r}function pe(t){for(var l=1;l<arguments.length;l++){var r=arguments[l]!=null?arguments[l]:{};l%2?de(Object(r),!0).forEach(function(s){_e(t,s,r[s])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(r)):de(Object(r)).forEach(function(s){Object.defineProperty(t,s,Object.getOwnPropertyDescriptor(r,s))})}return t}function _e(t,l,r){return l in t?Object.defineProperty(t,l,{value:r,enumerable:!0,configurable:!0,writable:!0}):t[l]=r,t}function fe(t,l){if(t==null)return{};var r=we(t,l),s,d;if(Object.getOwnPropertySymbols){var y=Object.getOwnPropertySymbols(t);for(d=0;d<y.length;d++){if(s=y[d],l.indexOf(s)>=0)continue;if(!Object.prototype.propertyIsEnumerable.call(t,s))continue;r[s]=t[s]}}return r}function we(t,l){if(t==null)return{};var r={},s=Object.keys(t),d,y;for(y=0;y<s.length;y++){if(d=s[y],l.indexOf(d)>=0)continue;r[d]=t[d]}return r}import*as A from"../utils/chart.js";import k,{useCallback as b,useEffect as L,useImperativeHandle as Oe,useMemo as B,useRef as J,useState as Q}from"../../web_modules/react.js";import{primaryColor as Ee,transitionProps as ke}from"../utils/style.js";import Re,{Wrapper as Te,useChartTheme as ze}from"../hooks/useECharts.js";import De from"../../web_modules/react-spinners/GridLoader.js";import Ie from"../../web_modules/lodash/defaultsDeep.js";import Le from"../../web_modules/styled-components.js";import Se from"../hooks/useThrottleFn.js";const Ye=Le.div.withConfig({displayName:"StackChart__Tooltip",componentId:"sc-1xrpgve-0"})(["position:absolute;z-index:1;background-color:var(--tooltip-background-color);color:var(--tooltip-text-color);border-radius:4px;padding:5px;display:none;",""],ke(["color","background-color"])),Ne=k.forwardRef(({options:t,data:l,title:r,loading:s,zoom:d,className:y,onInit:S},me)=>{var C,F;const V=l!=null?l:{minZ:0,maxZ:0,minY:0,maxY:0,minX:0,maxX:0,data:null},{minZ:X,maxZ:$,minY:h,maxY:P,minX:ee,maxX:te}=V,ne=fe(V,["minZ","maxZ","minY","maxY","minX","maxX"]),j=B(()=>{var e;return(e=ne.data)!==null&&e!==void 0?e:[]},[ne.data]),_=B(()=>h===0&&P===0?-.4:h-(P-h)*.4,[h,P]),w=b((e,n,i,a)=>{const o=a([e,n]);return o?(o[1]-=(i-X)/($-X)*(a([0,h])[1]-a([0,_])[1]),o):[0,0]},[X,$,h,_]),Y=b((e,n,i)=>{const a=[];let o=0;for(;j[e]&&o<j[e].length;){const c=n(o++),v=n(o++),m=n(o++);m!==1&&o===3&&a.push(w(c,v,1,i)),a.push(w(c,v,m,i)),m!==1&&o===j[e].length&&a.push(w(c,v,1,i))}return a},[w,j]),oe=b((e,n)=>{const i=Y(e.dataIndex,n.value,n.coord);return{type:"polygon",silent:!0,z:n.value(1),shape:{points:i},style:n.style({stroke:A.xAxis.axisLine.lineStyle.color,lineWidth:1})}},[Y]),[g,re]=Q(null),[O,U]=Q([]),x=J(null),[ve,ie]=Q(""),W=J(g),le=J(O);L(()=>{W.current=g},[g]),L(()=>{le.current=O},[O]);const R=t==null||((C=t.axisPointer)===null||C===void 0||((F=C.label)===null||F===void 0))?void 0:F.formatter,se=b(e=>!R||W.current==null?"":typeof R=="string"?R:R(e,le.current[W.current]),[R]),ae=ze(),f=B(()=>{const{color:e,colorAlt:n,toolbox:i,series:a}=A,o=fe(A,["color","colorAlt","toolbox","series"]);return Ie({title:{text:r!=null?r:""},visualMap:{min:h,max:P},axisPointer:{label:{formatter:se}},xAxis:{min:ee,max:te,axisPointer:{type:"none"}},yAxis:{inverse:!0,position:"right",min:_,max:P,axisLine:{onZero:!1},axisLabel:{formatter:c=>c<h?"":c+""},axisPointer:{type:"none"}},grid:{left:o.grid.right,right:o.grid.left},tooltip:{trigger:"none",showContent:!1,axisPointer:{axis:"y",snap:!1}},series:[pe(pe({},a),{},{type:"custom",silent:!0,data:j,renderItem:oe})]},t,ae,o)},[t,r,ae,j,ee,te,h,P,_,oe,se]),T=b(()=>{var e;re(null),U([]),((e=f.tooltip)===null||e===void 0?void 0:e.formatter)&&(ie(""),x.current&&(x.current.style.display="none"))},[f.tooltip]),ye=b((e,n)=>{try{var i,a,o,c;if(!e||!n)return;const{offsetX:E,offsetY:M}=n;if((i=M<_+f.grid.top)!==null&&i!==void 0?i:0){T();return}const[Pe,je]=e.convertFromPixel("grid",[E,M]),H=(a=(o=e.getOption().series)===null||o===void 0?void 0:o[0].data)!==null&&a!==void 0?a:[],G=H.map(p=>p[1]).sort((p,D)=>p-D);let K=0,z=null;for(;K<G.length;)if(je<=G[K++]){z=G[K-1];break}const q=z==null?null:H.findIndex(p=>p[1]===z);re(q);let Z=[];if(z==null||(Z=H.map(p=>{const D=[p[0],p[1],p[2]];let ce=Number.POSITIVE_INFINITY;for(let I=0;I<p.length;I+=3){const ue=Math.abs(p[I]-Pe);ue<ce&&(ce=ue,D[0]=p[I],D[2]=p[I+2])}return D})),U(Z),(c=f.tooltip)===null||c===void 0?void 0:c.formatter){var v,m;ie(q==null?"":(v=f.tooltip)===null||v===void 0||((m=v.formatter)===null||m===void 0)?void 0:m.call(v,Z[q])),x.current&&(z==null?x.current.style.display="none":(x.current.style.left=`${E+10}px`,x.current.style.top=`${M+10}px`,x.current.style.display="block"))}}catch(E){T()}},[T,_,f.grid,f.tooltip]),N=Se(ye,{wait:200}),he=b(e=>{try{const n=e.getZr();n&&(n.on("mousemove",i=>N.run(e,i)),n.on("mouseout",()=>{N.cancel(),T()}))}catch(n){N.cancel()}S==null||S(e)},[S,N,T]),{ref:xe,echart:u,wrapper:ge,saveAsImage:be}=Re({loading:!!s,zoom:d,autoFit:!0,onInit:he});return Oe(me,()=>({saveAsImage:()=>{be(r)}})),L(()=>{u==null||u.setOption(f,{notMerge:!0})},[u,f]),L(()=>{if(u)try{if(g==null)u.setOption({graphic:{elements:[{id:"highlight",type:"polyline",$action:"remove"}]}});else{var e,n;const i=(e=(n=u.getOption().series)===null||n===void 0?void 0:n[0].data)!==null&&e!==void 0?e:[],a=c=>u.convertToPixel("grid",c),o=c=>i[g][c];u.setOption({graphic:{elements:[{id:"highlight",type:"polyline",$action:"replace",silent:!0,cursor:"default",zlevel:1,z:1,shape:{points:Y(g,o,a)}}]}})}}catch(i){}},[g,u,Y]),L(()=>{if(u)try{if(O.length){const o=c=>u.convertToPixel("grid",c);u.setOption({graphic:{elements:O.map((c,v)=>{var m;const E=w(c[0],c[1],c[2],o);return{type:"circle",id:`dot${v}`,$action:"replace",cursor:"default",zlevel:1,z:2,shape:{cx:E[0],cy:E[1],r:3},style:{fill:"#fff",stroke:(m=f.color)===null||m===void 0?void 0:m[0],lineWidth:2}}})}})}else{var e,n,i,a;u.setOption({graphic:{elements:(e=u.getOption())===null||e===void 0||((n=e.graphic)===null||n===void 0||((i=n[0])===null||i===void 0||((a=i.elements)===null||a===void 0)))?void 0:a.filter(o=>o.id.startsWith("dot")).map(o=>({id:o.id,type:"circle",$action:"remove"}))}})}}catch(o){}},[O,u,f.color,w]),k.createElement(Te,{ref:ge,className:y},!u&&k.createElement("div",{className:"loading"},k.createElement(De,{color:Ee,size:"10px"})),k.createElement("div",{className:"echarts",ref:xe}),k.createElement(Ye,{className:"tooltip",ref:x,dangerouslySetInnerHTML:{__html:ve}}))});export default Ne;
