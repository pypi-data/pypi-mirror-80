#!/bin/sh

. ${0%/*}/test_helper.sh

tuxbuild_build="tuxbuild build --git-repo https://github.com/torvalds/linux.git --git-ref master --target-arch arm64 --kconfig defconfig --toolchain gcc-9"

test_build_pass() {
    api_v1 --build-failure-rate=0
    run ${tuxbuild_build}
    assertEquals 0 "$status"
}

test_build_fail() {
    api_v1 --build-failure-rate=100
    run ${tuxbuild_build}
    assertEquals 1 "$status"
}

test_build_pass_download() {
    api_v1 --build-failure-rate=0
    run ${tuxbuild_build} --download
    assertEquals 0 "$status"
    assertTrue "test -f */status.json"
    assertTrue "test -f */kernel.config"
    assertTrue "test -f */zImage"
}

test_build_fail_show_logs() {
    api_v1 --build-failure-rate=100
    run ${tuxbuild_build} --show-logs
    assertEquals 1 "$status"
    assertTrue 'prints build log' 'echo "${output}" | grep -q error:'
}

test_build_fail_show_logs_only_on_failure() {
    api_v1 --build-failure-rate=0
    run ${tuxbuild_build} --show-logs
    assertEquals 0 "$status"
    assertFalse 'does not print build log' 'echo "${output}" | grep -q "log line"'
}

. shunit2
